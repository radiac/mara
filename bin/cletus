#!/usr/bin/python

import getopt
import sys

import cletus.cli as cli
import cletus.log as log
import cletus.settings as settings
import cletus.util as util

USAGE_ERROR = 1

# Help
help_intro = """cli

A chatroom server
"""
help_usage = """Usage:
    cletus
        Run a server
"""
help_options = """Options:
    -h, --help
        Show this message
    
    --host=HOST
        Host to listen on
        Default: '' (all)
    
    --port=PORT
        Port to listen on
        Default: 9000
    
    --plugins=PATH
        Path to plugin directory
        Default: None
    
    -l LOGFILE, --logfile=LOGFILE
        Path to the logfile to use for the server
        Default: /var/log/socketproxy.log
    
    -v, --verbosity=LEVEL
        Log verbosity level for the server
        """ + "        \n".join( log.help_verbosity.strip().splitlines() ) + """
        Default: 0
"""

def usage(state=0):
    if not state:
        print help_intro
    print help_usage
    if not state:
        print help_options
    sys.exit(state)


#
# Argument parser and command dispatcher
#

def main(argv):
    """
    Main function to parse arguments and dispatch
    """
    # Find options
    try:
        opts, args = getopt.getopt(argv, 'hd', [
            'help', 'logfile=', 'verbosity=', 'plugins=', 'debug'
        ])
    except getopt.GetoptError, e:
        print "Invalid command line options: %s" % e
        usage(USAGE_ERROR)
    
    # Process options
    for opt, arg in opts:
        if opt in ('-h', '--help'):
            usage()
        
        elif opt == '--logfile':
            settings.logfile = arg
        
        elif opt == '--verbosity':
            settings.verbosity = int(arg)
            
        elif opt == '--plugins':
            settings.plugins = arg
        
        elif opt in ('-d', '--debug'):
            settings.debug = True
        
    # Start logger
    log.init()
    
    # Server
    try:
        cli.run(settings)
    except Exception, e:
        log.manager(
            'Fatal error: %s' % e + "\n".join( util.detail_error() )
        )
        
if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except KeyboardInterrupt:
        sys.exit(1)
